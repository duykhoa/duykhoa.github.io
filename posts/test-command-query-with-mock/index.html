<!doctype html><html lang=en-us><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Test Command Handler With Mock | Kevin's Blog</title>
<meta name=title content="Test Command Handler With Mock"><meta name=description content="This post demonstrates how to test command and query handlers in a Command Query Separation based project."><meta name=author content><meta name=keywords content="architecture,golang,domain driven development,"><meta property="og:url" content="https://duykhoa.github.io/posts/test-command-query-with-mock/"><meta property="og:site_name" content="Kevin's Blog"><meta property="og:title" content="Test Command Handler With Mock"><meta property="og:description" content="This post demonstrates how to test command and query handlers in a Command Query Separation based project."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-10-23T21:26:22-04:00"><meta property="article:modified_time" content="2024-10-23T21:26:22-04:00"><meta property="article:tag" content="Architecture"><meta property="article:tag" content="Golang"><meta property="article:tag" content="Domain Driven Development"><meta name=twitter:card content="summary"><meta name=twitter:title content="Test Command Handler With Mock"><meta name=twitter:description content="This post demonstrates how to test command and query handlers in a Command Query Separation based project."><meta itemprop=name content="Test Command Handler With Mock"><meta itemprop=description content="This post demonstrates how to test command and query handlers in a Command Query Separation based project."><meta itemprop=datePublished content="2024-10-23T21:26:22-04:00"><meta itemprop=dateModified content="2024-10-23T21:26:22-04:00"><meta itemprop=wordCount content="511"><meta itemprop=keywords content="Architecture,Golang,Domain Driven Development"><meta name=referrer content="no-referrer-when-downgrade"><link href=/original.min.css rel=stylesheet><link href=/syntax.min.css rel=stylesheet></head><body><header><a class=skip-link href=#main-content>Skip to main content</a>
<a href=/ class=title><h1>Kevin's Blog</h1></a><nav><a href=/posts/>Blog</a>
<a href=/about/>About</a>
<a href=https://duykhoa.github.io/index.xml>RSS</a></nav></header><main id=main-content><h1>Test Command Handler With Mock</h1><p class=byline><time datetime=2024-10-23 pubdate>2024-10-23</time></p><content><p>This post demonstrates how to test command and query handlers in a <a href=/content/posts/command-query-in-go-project/index.md>Command Query Separation based</a> project.</p><h2 id=cqs-structure>CQS Structure</h2><p>Testing Query and Command handlers involves similar techniques, this post will demonstrate testing Command handlers. The principles can be easily applied to Query handlers.</p><p>The CQS structure defines a command handler interface, which receives a <code>C</code> generic command object and return nothing but an error in non-happy path.</p><p>The <code>CreateArticleHandler</code> is a specific interface which handle the <code>CreateArticle</code> command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CommandHandler</span>[<span style=color:#a6e22e>C</span> <span style=color:#a6e22e>any</span>] <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Handle</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>cmd</span> <span style=color:#a6e22e>C</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CreateArticleHandler</span> = <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>CommandHandler</span>[<span style=color:#a6e22e>CreateArticle</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>createArticleHandler</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>repo</span> <span style=color:#a6e22e>ArticleRepository</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>createArticleHandler</span>) <span style=color:#a6e22e>Handle</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>cmd</span> <span style=color:#a6e22e>CreateArticle</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// TODO
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}</span></span></code></pre></div><p>Given the command handler is following this structure, we need to test the command handler and the higher component, e.g the controller.</p><p>We need to deal with the command handler&rsquo;s dependency first, which is the <code>ArticleRepository</code>. It would be easier if the <code>ArticleRepository</code> is an interface. If there is no interface for the repository, please consider to have define the interface and use the interface for the repo dependency.</p><p>With the interface setup, we can create a dummy implementation to test the <code>ArticleRepository</code>. [mockery<code>](https://github.com/vektra/mockery) or [gomock](https://github.com/uber-go/mock) could do the boring works by creating a mock implementation for the interface. By specify the </code>go:generate<code>comment,</code>go generate` will generate the mock for us.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#75715e>// file location: internal/domain/article/repository.go
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>//go:generate mockgen -destination mocks/mock_article_repository.go -package mocks . ArticleRepository
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ArticleRepository</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CreateArticle</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>article</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Article</span>,
</span></span><span style=display:flex><span>	) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>The mocked article repository is extremely useful in simulating different scenarios, here is an example where the repository returning an error when creating new article</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#a6e22e>ctrl</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gomock</span>.<span style=color:#a6e22e>NewController</span>(<span style=color:#a6e22e>t</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>repo</span>.<span style=color:#a6e22e>EXPECT</span>().<span style=color:#a6e22e>CreateArticle</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gomock</span>.<span style=color:#a6e22e>Any</span>(),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gomock</span>.<span style=color:#a6e22e>AssignableToTypeOf</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>domain</span>.<span style=color:#a6e22e>Article</span>{}),
</span></span><span style=display:flex><span>).<span style=color:#a6e22e>Return</span>(<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;invalid article category&#34;</span>))</span></span></code></pre></div><p>The full testcase written with <a href=https://github.com/onsi/ginkgo>Ginkgo</a> (this is optional). There is no expensive setup with actual DB connection, the syntax is very descriptive.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#a6e22e>It</span>(<span style=color:#e6db74>&#34;failed to create article&#34;</span>, <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>id</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>uuid</span>.<span style=color:#a6e22e>New</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>repo</span>.<span style=color:#a6e22e>EXPECT</span>().<span style=color:#a6e22e>CreateArticle</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>gomock</span>.<span style=color:#a6e22e>Any</span>(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>gomock</span>.<span style=color:#a6e22e>AssignableToTypeOf</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>domain</span>.<span style=color:#a6e22e>Article</span>{}),
</span></span><span style=display:flex><span>    ).<span style=color:#a6e22e>Return</span>(<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;invalid article category&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cmd</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>command</span>.<span style=color:#a6e22e>NewCreateArticleHandler</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>repo</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>logger</span>,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Handle</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>command</span>.<span style=color:#a6e22e>CreateArticle</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Article</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>domain</span>.<span style=color:#a6e22e>Article</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ArticleID</span>: <span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Expect</span>(<span style=color:#a6e22e>err</span>).<span style=color:#a6e22e>To</span>(<span style=color:#a6e22e>HaveOccurred</span>())
</span></span><span style=display:flex><span>})</span></span></code></pre></div><p>After complete both successful and failed scenarios for the command handlers, we can move on to test the higher component (e.g the <code>ArticlesController</code>), which uses the command handler as a dependency.</p><p>The same mocking strategy can be applied, add a single line of <code>go:generate</code> command to the command handler interface:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//go:generate mockgen -destination mocks/mock_create_article.go -package mocks . CreateArticleHandler
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CreateArticleHandler</span> = <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>CommandHandler</span>[<span style=color:#a6e22e>CreateArticle</span>]</span></span></code></pre></div><p>By adding this comment, the <code>go generate</code> command will generates the mock implementation for the command handler, which allows to setup different scenarios to test the higher component.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#a6e22e>It</span>(<span style=color:#e6db74>&#34;returns 500 response when creating article command returning an error&#34;</span>, <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cmdError</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;create article error&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cmd</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mocks</span>.<span style=color:#a6e22e>NewMockCreateArticleHandler</span>(<span style=color:#a6e22e>mockCtrl</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>controller</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ports</span>.<span style=color:#a6e22e>NewArticlesController</span>(<span style=color:#a6e22e>cmd</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cmd</span>.
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>EXPECT</span>().
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Handle</span>(
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>gomock</span>.<span style=color:#a6e22e>Any</span>(),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>gomock</span>.<span style=color:#a6e22e>AssignableToTypeOf</span>(<span style=color:#a6e22e>command</span>.<span style=color:#a6e22e>CreateArticle</span>{}),
</span></span><span style=display:flex><span>        ).
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Return</span>(<span style=color:#a6e22e>cmdError</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>controller</span>.<span style=color:#a6e22e>CreateArticle</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>generateRequest</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Expect</span>(<span style=color:#a6e22e>err</span>).<span style=color:#a6e22e>To</span>(<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>cmdError</span>))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Expect</span>(<span style=color:#a6e22e>resp</span>).<span style=color:#a6e22e>To</span>(<span style=color:#a6e22e>BeAssignableToTypeOf</span>(<span style=color:#a6e22e>ports</span>.<span style=color:#a6e22e>CreateArticle500Response</span>{}))
</span></span><span style=display:flex><span>})</span></span></code></pre></div><p>To test the happy scenario, modify the mock expectation setup by setting the <code>Return</code> parameter to nil.</p><h1 id=conclusion>Conclusion</h1><p>By enforcing a clean separation of concerns, CQS makes it easier to write targeted tests for individual components. This increased testability leads to higher quality software, as bugs can be identified and fixed more efficiently.</p></content><p><a class=blog-tags href=/tags/architecture/>#architecture</a>
<a class=blog-tags href=/tags/golang/>#golang</a>
<a class=blog-tags href=/tags/domain-driven-development/>#domain driven development</a></p><p><a href='mailto:duykhoa12t[at]gmail[dot]com?subject=Reply%20to%20"Test%20Command%20Handler%20With%20Mock"'>Reply to this post by email ↪</a></p></main><footer><small>Kevin Tran | Made with <a href=https://github.com/clente/hugo-bearcub>Bear Cub</a></small></footer></body></html>